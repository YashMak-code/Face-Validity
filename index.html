<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒç¥ä¸å®ï¼šæ„å¿µä¸æ¢é’ˆéªŒè¯ V3.0</title>
    <style>
        :root {
            /* é…è‰²å‡çº§ï¼šæ›´ä¸“ä¸šã€æŸ”å’Œçš„å¿ƒç†å­¦è“ */
            --primary: #5c8ae6;
            --primary-dark: #406cc7;
            --accent: #ff9f43;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-height: 85vh;
        }

        h1 { font-size: 1.4rem; text-align: center; color: var(--primary); margin: 0 0 15px 0; font-weight: 700; }
        p { line-height: 1.6; color: #555; font-size: 15px; margin-bottom: 20px; }

        .step { display: none; flex: 1; flex-direction: column; animation: fadeIn 0.4s ease; }
        .step.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- æŒ‰é’® --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            margin-top: auto;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(92, 138, 230, 0.3);
            transition: transform 0.1s, background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.98); background: var(--primary-dark); }
        .btn-secondary { background: #e0e6ed; color: #555; box-shadow: none; margin-top: 10px; }

        .btn-undo {
            background: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            padding: 8px;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
            align-self: center;
            display: flex; align-items: center; gap: 5px;
            border-radius: 20px;
        }
        .btn-undo:disabled { border-color: #ccc; color: #ccc; }

        /* --- è¾“å…¥æ¡†ä¸æ ‡ç­¾ --- */
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-box { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; transition: border 0.3s; }
        .input-box:focus { border-color: var(--primary); outline: none; }

        .tag-container {
            display: flex; flex-wrap: wrap; gap: 10px; padding: 15px;
            background: #f8f9fa; border-radius: 12px; min-height: 100px;
            align-content: flex-start; margin-bottom: 20px;
        }
        .tag {
            background: #eef4ff; color: var(--primary);
            padding: 6px 14px; border-radius: 20px; font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 6px;
        }

        /* --- é˜¶æ®µ 3ï¼šåˆ†ç±»äº¤äº’ --- */
        .deck-area {
            background: white;
            position: sticky; top: 0; z-index: 10;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 15px;
            display: flex; flex-direction: column; align-items: center;
        }

        .current-card {
            background: white;
            border: 2px solid var(--primary);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(92, 138, 230, 0.15);
            font-size: 17px;
            font-weight: 500;
            text-align: center;
            min-height: 80px;
            width: 90%;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }

        .probe-tag {
            background: #ff9f43; color: white;
            font-size: 10px; padding: 2px 6px; border-radius: 4px;
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .buckets-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            padding-bottom: 10px; flex: 1; overflow-y: auto;
        }

        .bucket {
            background: #ffffff;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            padding: 15px 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            min-height: 90px;
        }
        .bucket:active { background: #f5f7fa; transform: scale(0.97); }
        .bucket h4 { margin: 0; font-size: 15px; color: #333; pointer-events: none; }
        .bucket p { font-size: 11px; color: #888; margin: 4px 0 0 0; pointer-events: none; }

        .bucket-badge {
            position: absolute; top: 5px; right: 5px;
            background: var(--primary); color: white;
            font-size: 10px; padding: 2px 6px; border-radius: 10px;
            opacity: 0; transition: opacity 0.2s;
        }
        .bucket-badge.show { opacity: 1; }

        /* --- è¿›åº¦æ¡ä¸ç»“æœ --- */
        .progress-container { width: 100%; background: #eee; height: 6px; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 25%; transition: width 0.5s ease; }

        textarea { width: 100%; border: 2px solid #eee; border-radius: 10px; padding: 10px; font-family: monospace; font-size: 12px; resize: none; }

    </style>
</head>
<body>

<div class="container">
    <div class="progress-container"><div class="progress-fill" id="progress"></div></div>

    <div id="step1" class="step active">
        <h1>é˜¶æ®µä¸€ï¼šç›´è§‰è”æƒ³</h1>
        <p>å½“æåˆ° <strong>â€œå¿ƒç¥ä¸å®â€</strong> è¿™ä¸ªè¯æ—¶ï¼Œä½ è„‘æµ·ä¸­ç¬¬ä¸€æ—¶é—´ä¼šæµ®ç°å‡ºå“ªäº›ç—‡çŠ¶ã€æ„Ÿå—æˆ–ç”»é¢ï¼Ÿ</p>

        <div class="input-group">
            <input type="text" id="wordInput" class="input-box" placeholder="ä¾‹å¦‚ï¼šå¿ƒæ…Œã€ä¹±æƒ³...">
            <button style="width: auto; margin:0;" class="btn" onclick="addTag()">æ·»åŠ </button>
        </div>

        <div class="tag-container" id="tagCloud">
            <span style="color:#999; width:100%; text-align:center; margin-top:10px;">(æš‚æ— æ ‡ç­¾ï¼Œè¯·æ·»åŠ )</span>
        </div>
        <button class="btn" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="step2" class="step">
        <h1>é˜¶æ®µäºŒï¼šç›´è§‰åŒ¹é…</h1>
        <p>åŸºäºç†è®ºï¼Œæˆ‘ä»¬å°†â€œå¿ƒç¥ä¸å®â€æ‹†è§£ä¸ºä»¥ä¸‹ 5 ä¸ªç»´åº¦ã€‚è¯·é˜…è¯»å¹¶åˆ¤æ–­ï¼š<strong>è¿™äº›ç»´åº¦æ˜¯å¦ç¬¦åˆæ‚¨æƒ³è¦è¡¨è¾¾çš„å†…å®¹ï¼Ÿ</strong></p>

        <div style="background:#f8f9fa; border-radius:12px; padding:15px; margin-bottom:20px;">
            <ul style="padding-left: 20px; margin:0; font-size: 14px; color: #444; line-height: 1.8;">
                <li><strong>â‘  æƒ…ç»ªçƒ¦èºï¼š</strong>å¿ƒé‡Œçƒ¦ä¹±ã€æ˜“æ€’</li>
                <li><strong>â‘¡ è¿‡åº¦æ€è™‘ï¼š</strong>åå¤æ‹…å¿§ã€è„‘å­åœä¸ä¸‹æ¥</li>
                <li><strong>â‘¢ æ³¨æ„æ§åˆ¶ä¸‹é™ï¼š</strong>èµ°ç¥ã€è„‘å­ç©ºç™½</li>
                <li><strong>â‘£ ç¡çœ å›°æ‰°ï¼š</strong>ç¿»æ¥è¦†å»ã€å¤šæ¢¦æ—©é†’</li>
                <li><strong>â‘¤ èº¯ä½“é«˜å”¤é†’ï¼š</strong>å¿ƒæ…Œã€æ˜“æƒŠã€åç«‹éš¾å®‰</li>
            </ul>
        </div>

        <p style="margin-bottom:10px; font-size:14px;"><strong>æ˜¯å¦æœ‰é—æ¼ï¼Ÿ</strong> (è‹¥æœ‰ï¼Œè¯·è¡¥å……ï¼›è‹¥æ— ï¼Œè¯·ç•™ç©º)</p>
        <textarea id="dimensionComment" style="height:60px;" placeholder="æˆ‘è§‰å¾—è¿˜åº”è¯¥åŒ…å«..."></textarea>

        <button class="btn" onclick="nextStep(3)">ç¡®è®¤ï¼Œå¼€å§‹åˆ†ç±»ä»»åŠ¡</button>
    </div>

    <div id="step3" class="step">
        <h1>é˜¶æ®µä¸‰ï¼šæ¡ç›®å½’ç±»</h1>

        <div class="deck-area">
            <div id="cardDisplay" class="current-card">
                </div>
            <button class="btn btn-undo" id="undoBtn" onclick="undoLastSort()" disabled>
                â†©ï¸ æ’¤é”€ä¸Šä¸€æ­¥
            </button>
            <div style="font-size: 12px; color: #aaa; margin-top: 8px;">åŒ…å«ä¸»é‡è¡¨é¢˜ç›®ä¸çŸ­æ¢é’ˆï¼Œè¯·å‡­ç›´è§‰å½’ç±»</div>
        </div>

        <div class="buckets-grid">
            <div class="bucket" onclick="placeCard('E')">
                <span class="bucket-badge" id="badge-E">0</span>
                <h4 style="color:#e67e22">æƒ…ç»ªçƒ¦èº</h4><p>çƒ¦ä¹±/æ˜“æ€’</p>
            </div>
            <div class="bucket" onclick="placeCard('R')">
                <span class="bucket-badge" id="badge-R">0</span>
                <h4 style="color:#9b59b6">è¿‡åº¦æ€è™‘</h4><p>æ‹…å¿§/åœä¸ä¸‹</p>
            </div>
            <div class="bucket" onclick="placeCard('A')">
                <span class="bucket-badge" id="badge-A">0</span>
                <h4 style="color:#3498db">æ³¨æ„æ§åˆ¶ä¸‹é™</h4><p>èµ°ç¥/ç©ºç™½</p>
            </div>
            <div class="bucket" onclick="placeCard('SD')">
                <span class="bucket-badge" id="badge-SD">0</span>
                <h4 style="color:#2ecc71">ç¡çœ å›°æ‰°</h4><p>å¤±çœ /å¤šæ¢¦</p>
            </div>
            <div class="bucket" onclick="placeCard('SH')">
                <span class="bucket-badge" id="badge-SH">0</span>
                <h4 style="color:#e74c3c">èº¯ä½“é«˜å”¤é†’</h4><p>å¿ƒæ…Œ/æ˜“æƒŠ</p>
            </div>
            <div class="bucket" style="background:#f2f2f2; border-color:#ccc;" onclick="placeCard('Trash')">
                <span class="bucket-badge" style="background:#999" id="badge-Trash">0</span>
                <h4 style="color:#7f8c8d">ä¸ç¡®å®š/è·³è¿‡</h4>
            </div>
        </div>
    </div>

    <div id="step4" class="step">
        <h1>ğŸ‰ æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</h1>
        <p>æ‚¨çš„åˆ†ç±»æ•°æ®å¯¹æˆ‘ä»¬éå¸¸é‡è¦ã€‚è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶æ•°æ®ï¼Œå‘é€ç»™ç ”ç©¶è€…ã€‚</p>

        <button class="btn" style="background:#27ae60; margin-bottom:15px;" onclick="copyToClipboard()">ğŸ“‹ ä¸€é”®å¤åˆ¶æ•°æ®</button>
        <button class="btn btn-secondary" onclick="downloadData()">å¤‡ç”¨ï¼šä¸‹è½½æ–‡ä»¶</button>

        <p style="font-size: 12px; margin-top: 15px; color:#999;">æ•°æ®é¢„è§ˆ (å·²åŠ å¯†ä¸ªäººä¿¡æ¯)ï¼š</p>
        <textarea class="json-box" id="resultOutput" readonly></textarea>
    </div>
</div>

<script>
    // --- V3.0 æ•°æ®æºï¼šå…¨é‡æ›´æ–° ---
    const rawItems = [
        // === ä¸»é‡è¡¨æ¡ç›® (MRS) ===
        { id: "E1", content: "æˆ‘ç»å¸¸æ„Ÿåˆ°å¿ƒé‡Œçƒ¦ä¹±ï¼Œéš¾ä»¥å®‰é™ä¸‹æ¥ã€‚", target: "E" },
        { id: "E2", content: "æˆ‘å®¹æ˜“å› ä¸ºä¸€äº›å°äº‹è€Œç”Ÿæ°”æˆ–å‘è„¾æ°”ã€‚", target: "E" },
        { id: "E3", content: "å½“ç¯å¢ƒæˆ–è®¡åˆ’å‡ºç°å˜åŒ–æ—¶ï¼Œæˆ‘ä¼šæ„Ÿåˆ°çƒ¦èºã€‚", target: "E" },
        { id: "E4", content: "å‘¨å›´çš„å£°éŸ³æˆ–ä»–äººå¹²æ‰°ä¼šè®©æˆ‘ä¸è€çƒ¦ã€‚", target: "E" },

        { id: "R1", content: "æˆ‘ä¼šåå¤æƒ³ç€æœ€è¿‘å‘ç”Ÿçš„ã€è®©æˆ‘ä¸å®‰æˆ–çƒ¦å¿ƒçš„äº‹ã€‚", target: "R" },
        { id: "R2", content: "æˆ‘ä¼šåå¤æ‹…å¿§æ¥ä¸‹æ¥è¦é¢å¯¹çš„äº‹æˆ–è¿˜æ²¡å¤„ç†å®Œçš„äº‹ï¼Œå¿ƒé‡Œæ”¾ä¸ä¸‹ã€‚", target: "R" },
        { id: "R3", content: "å³ä½¿æˆ‘ä¸æƒ³å†æƒ³æŸäº›äº‹ï¼Œè¿™äº›å¿µå¤´ä¹Ÿä¼šåå¤å†’å‡ºæ¥ã€‚", target: "R" },
        { id: "R4", content: "å½“è¿™äº›å¿µå¤´å‡ºç°æ—¶ï¼Œæˆ‘å¾ˆéš¾æŠŠæ³¨æ„åŠ›ä»å®ƒä»¬ä¸Šé¢è½¬å¼€ã€‚", target: "R" },

        { id: "A1", content: "æˆ‘ç»å¸¸ä¼šå¿½ç„¶è„‘å­é™·å…¥ä¸€ç‰‡ç©ºç™½ï¼Œä¸€æ—¶å›ä¸è¿‡ç¥ã€‚", target: "A" },
        { id: "A2", content: "åšäº‹æ—¶ï¼Œæˆ‘çš„æ€ç»ªæ€»æ˜¯ä¸å—æ§åˆ¶åœ°â€œè·‘â€åˆ°åˆ«çš„åœ°æ–¹å»ã€‚", target: "A" },
        { id: "A3", content: "æˆ‘æ„Ÿåˆ°å¾ˆéš¾é•¿æ—¶é—´ç»´æŒä¸“æ³¨ã€‚", target: "A" },
        { id: "A4", content: "æˆ‘å¸¸ä¼šå¿˜è®°è‡ªå·±åˆšè¦åšä»€ä¹ˆ/åˆšåœ¨åšä»€ä¹ˆã€‚", target: "A" },
        { id: "A5", content: "æˆ‘æ„Ÿè§‰è„‘å­å’Œæ€è·¯å¾ˆä¹±ï¼Œç†ä¸æ¸…å¤´ç»ªã€‚", target: "A" },

        { id: "SD1", content: "æˆ‘èººåœ¨åºŠä¸Šç¿»æ¥è¦†å»ï¼Œè„‘å­é™ä¸ä¸‹æ¥ï¼Œå¾ˆä¹…æ‰èƒ½å…¥ç¡ã€‚", target: "SD" },
        { id: "SD2", content: "æˆ‘ç¡è§‰æ—¶çš„æ¢¦å¾ˆå¤šã€å¾ˆä¹±ã€‚", target: "SD" },
        { id: "SD3", content: "æˆ‘å¤œé‡Œç¡å¾—ä¸å®‰ç¨³ï¼Œå®¹æ˜“é†’æ¥ã€‚", target: "SD" },
        { id: "SD4", content: "é†’æ¥æ—¶ï¼Œæˆ‘æ„Ÿè§‰è„‘å­è¿˜æ˜¯å¾ˆæ²‰ï¼Œåƒæ²¡æœ‰ä¼‘æ¯è¿‡ä¸€æ ·ã€‚", target: "SD" },

        { id: "SH1", content: "å³ä½¿æ²¡æœ‰å‰§çƒˆè¿åŠ¨ï¼Œæˆ‘ä¹Ÿä¼šæ„Ÿè§‰åˆ°å¿ƒè·³åŠ å¿«æˆ–å¿ƒæ…Œã€‚", target: "SH" },
        { id: "SH2", content: "æˆ‘å®¹æ˜“è¢«ä¸€äº›çªç„¶çš„å°å£°éŸ³æˆ–åŠ¨ä½œå“ä¸€è·³ã€‚", target: "SH" },
        { id: "SH3", content: "æˆ‘å¸¸æ„Ÿåˆ°èƒ¸å£ç´§ç´§çš„ï¼Œåƒæ˜¯â€œæ†‹ç€ä¸€å£æ°”â€ï¼Œéš¾ä»¥æ”¾æ¾ã€‚", target: "SH" },
        { id: "SH4", content: "æˆ‘å¸¸å¸¸æ„Ÿåˆ°åç«‹éš¾å®‰ï¼Œéš¾ä»¥æ”¾æ¾ã€‚", target: "SH" },

        // === æ¢é’ˆæ¡ç›® (MRS-P) ===
        { id: "EP1", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ„Ÿåˆ°å¿ƒé‡Œå¾ˆçƒ¦ï¼Œéš¾ä»¥å®‰å®ã€‚", target: "E", isProbe: true },
        { id: "EP2", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ„Ÿåˆ°èºåŠ¨ä¸å®‰ï¼Œä¸€ç‚¹å°±ç€ã€‚", target: "E", isProbe: true },
        { id: "RP1", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘çš„è„‘å­åœä¸ä¸‹æ¥ï¼Œå¿µå¤´ä¸æ–­ã€‚", target: "R", isProbe: true },
        { id: "RP2", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ§åˆ¶ä¸ä½åœ°åœ¨åå¤æƒ³äº‹æƒ…ã€‚", target: "R", isProbe: true },
        { id: "AP1", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘çš„æ³¨æ„åŠ›éš¾ä»¥é›†ä¸­ã€‚", target: "A", isProbe: true },
        { id: "AP2", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘å¾ˆéš¾æŠŠæ³¨æ„åŠ›ä»æ— å…³çš„æƒ³æ³•ä¸Šæ‹‰å›æ¥ã€‚", target: "A", isProbe: true },
        { id: "SDP1", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ„Ÿè§‰è„‘å­è½¬ä¸åŠ¨äº†ï¼Œä½†åˆé™ä¸ä¸‹æ¥ã€‚", target: "SD", isProbe: true },
        { id: "SDP2", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ„Ÿè§‰èº«ä½“å¾ˆç–²æƒ«ï¼Œä½†å¾ˆéš¾å½»åº•æ”¾æ¾ã€‚", target: "SD", isProbe: true },
        { id: "SHP1", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘æ„Ÿè§‰èƒ¸å£å‘ç´§ï¼Œå‘¼å¸ä¸å¤ªé¡ºç•…ã€‚", target: "SH", isProbe: true },
        { id: "SHP2", content: "ã€æ¢é’ˆã€‘æ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘èƒ½æ„Ÿè§‰åˆ°å¿ƒè·³æ›´æ˜æ˜¾æˆ–å¿ƒæ…Œã€‚", target: "SH", isProbe: true }
    ];

    let userTags = [];
    let sortResults = [];
    let shuffledDeck = [];
    let bucketCounts = { E:0, R:0, A:0, SD:0, SH:0, Trash:0 };

    window.onload = function() {
        shuffledDeck = [...rawItems].sort(() => Math.random() - 0.5);
        updateProgress(1);
    };

    function addTag() {
        const input = document.getElementById("wordInput");
        const val = input.value.trim();
        if (val) {
            userTags.push(val);
            const container = document.getElementById("tagCloud");
            if (userTags.length === 1) container.innerHTML = "";
            container.innerHTML += `<div class="tag">${val}</div>`;
            input.value = "";
            input.focus();
        }
    }

    function renderCard() {
        const cardDiv = document.getElementById("cardDisplay");
        const undoBtn = document.getElementById("undoBtn");

        undoBtn.disabled = sortResults.length === 0;
        undoBtn.style.opacity = sortResults.length === 0 ? 0.5 : 1;

        if (shuffledDeck.length === 0) {
            nextStep(4);
            return;
        }

        const item = shuffledDeck[0];
        const remaining = shuffledDeck.length;

        // æ¢é’ˆç‰¹æ®Šæ ·å¼æ ‡è®°
        const probeBadge = item.isProbe ? `<div class="probe-tag">çŸ­æ¢é’ˆ</div>` : '';
        const cardStyle = item.isProbe ? "border-color: #ff9f43;" : "";

        cardDiv.innerHTML = `
            <div style="width:100%; position:relative;">
                ${probeBadge}
                <div style="font-size:12px;color:#999;margin-bottom:8px;text-align:right">å‰©ä½™ ${remaining} é¢˜</div>
                <div style="font-size:16px;line-height:1.5;">${item.content.replace("ã€æ¢é’ˆã€‘", "")}</div>
            </div>
        `;
        cardDiv.style.borderColor = item.isProbe ? "#ff9f43" : "#5c8ae6";

        cardDiv.style.transform = "scale(0.98)";
        setTimeout(() => cardDiv.style.transform = "scale(1)", 100);
    }

    function placeCard(bucketId) {
        if (shuffledDeck.length === 0) return;
        const currentItem = shuffledDeck[0];
        sortResults.push({
            id: currentItem.id,
            content: currentItem.content,
            bucket: bucketId,
            target: currentItem.target,
            correct: currentItem.target === bucketId,
            isProbe: !!currentItem.isProbe
        });
        bucketCounts[bucketId]++;
        updateBadge(bucketId);
        shuffledDeck.shift();
        renderCard();
    }

    function undoLastSort() {
        if (sortResults.length === 0) return;
        const lastAction = sortResults.pop();
        bucketCounts[lastAction.bucket]--;
        updateBadge(lastAction.bucket);
        const itemToRestore = rawItems.find(i => i.id === lastAction.id);
        shuffledDeck.unshift(itemToRestore);
        renderCard();
    }

    function updateBadge(id) {
        const badge = document.getElementById(`badge-${id}`);
        badge.innerText = bucketCounts[id];
        badge.classList.add("show");
        if(bucketCounts[id] === 0) badge.classList.remove("show");
    }

    function nextStep(step) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        document.getElementById('progress').style.width = (step/4)*100 + "%";
        if (step === 3) renderCard();
        if (step === 4) generateResult();
    }

    function generateResult() {
        // è®¡ç®—æ¢é’ˆæ­£ç¡®ç‡
        const probes = sortResults.filter(r => r.isProbe);
        const mainItems = sortResults.filter(r => !r.isProbe);

        const data = {
            phase1_tags: userTags,
            phase2_comment: document.getElementById("dimensionComment").value,
            stats: {
                main_accuracy: Math.round((mainItems.filter(r=>r.correct).length / Math.max(1, mainItems.length))*100) + "%",
                probe_accuracy: Math.round((probes.filter(r=>r.correct).length / Math.max(1, probes.length))*100) + "%"
            },
            details: sortResults.map(r => ({ id: r.id, bucket: r.bucket, correct: r.correct, isProbe: r.isProbe }))
        };
        document.getElementById("resultOutput").value = JSON.stringify(data);
    }

    function copyToClipboard() {
        const copyText = document.getElementById("resultOutput");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("âœ… å¤åˆ¶æˆåŠŸï¼\nè¯·å»å¾®ä¿¡ç²˜è´´ç»™åŒå­¦ã€‚");
        }).catch(() => {
            alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰æ–‡æœ¬æ¡†å†…å®¹å¤åˆ¶ã€‚");
        });
    }

    function downloadData() {
        const text = document.getElementById("resultOutput").value;
        const blob = new Blob([text], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `MRS_V3_Data_${new Date().getTime()}.txt`;
        a.click();
    }
</script>

</body>
</html>
